---

title: Title


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/02_load_embeds.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/02_load_embeds.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.autograd</span> <span class="kn">import</span> <span class="n">Variable</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#                         [18,&#39;Private&#39;,182308,&#39;Bachelors&#39;,10.0,&#39;Never-married&#39;,&#39;?&#39;,&#39;Own-child&#39;,&#39;Other&#39;,&#39;Male&#39;,0,0,23,&#39;United-States&#39;,&#39;&lt;50k&#39;]],</span>
<span class="c1">#                         columns=df1.columns)</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../data/toy_dataset.csv&#39;</span><span class="p">)</span>
<span class="c1"># df2 = df2.append(new_rows, ignore_index=True)</span>

<span class="n">splits2</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">(</span><span class="n">valid_pct</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">range_of</span><span class="p">(</span><span class="n">df2</span><span class="p">))</span>
<span class="n">to2</span> <span class="o">=</span> <span class="n">TabularPandas</span><span class="p">(</span><span class="n">df2</span><span class="p">,</span> <span class="n">procs</span><span class="o">=</span><span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span><span class="n">Normalize</span><span class="p">],</span>
                   <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;City&#39;</span><span class="p">,</span><span class="s1">&#39;sex&#39;</span><span class="p">],</span>
                   <span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Number&#39;</span><span class="p">,</span> <span class="s1">&#39;Income&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">],</span>
                   <span class="n">y_names</span><span class="o">=</span><span class="s1">&#39;Illness&#39;</span><span class="p">,</span>
                   <span class="n">splits</span><span class="o">=</span><span class="n">splits2</span><span class="p">)</span>
<span class="n">dls2</span> <span class="o">=</span> <span class="n">to2</span><span class="o">.</span><span class="n">dataloaders</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">learn2</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls2</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.292761</td>
      <td>0.285474</td>
      <td>0.919667</td>
      <td>00:17</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">row</span><span class="p">,</span> <span class="n">clas</span><span class="p">,</span> <span class="n">probs</span> <span class="o">=</span> <span class="n">learn2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>City</th>
      <th>sex</th>
      <th>Number</th>
      <th>Income</th>
      <th>Age</th>
      <th>Illness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Austin</td>
      <td>Female</td>
      <td>150000.001614</td>
      <td>87251.00002</td>
      <td>37.0</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clas</span><span class="p">,</span> <span class="n">probs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(0), tensor([0.9314, 0.0686]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">TabTransfer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_path</span><span class="p">,</span> <span class="n">new_learner</span><span class="p">,</span> <span class="n">data_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span> <span class="c1">## for storing models</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">new_cat_names</span> <span class="o">=</span> <span class="n">new_learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">cat_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_all_classes</span> <span class="o">=</span> <span class="n">new_learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span> <span class="o">=</span> <span class="n">new_learner</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">json_path</span> <span class="o">=</span> <span class="n">json_path</span>
        
<span class="c1">#     def pickle_(self, )</span>
    
    <span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">json_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">json_file</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_cat_names</span> <span class="o">=</span> <span class="n">json_file</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span>
        <span class="n">classes_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_cat_names</span><span class="p">)</span>
        <span class="n">embed_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_cat_names</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_cat_names</span><span class="p">:</span>
            <span class="n">classes_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_file</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span>
            <span class="n">embed_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">json_file</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;embeddings&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_all_classes</span> <span class="o">=</span> <span class="n">classes_dict</span> <span class="c1"># contains the cat variable with all its classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_all_embeds</span> <span class="o">=</span> <span class="n">embed_dict</span> <span class="c1"># contains the cat variable with all its embeddings</span>
        
    <span class="k">def</span> <span class="nf">transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat_names_to_transfer</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_list</span> <span class="o">=</span> <span class="n">cat_names_to_transfer</span>
        
        <span class="k">for</span> <span class="n">curr_cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">curr_cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_cat_names</span> <span class="ow">and</span> <span class="n">curr_cat</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_cat_names</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">old_cat_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_cat_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">curr_cat</span><span class="p">)</span>
            <span class="n">new_cat_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_cat_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">curr_cat</span><span class="p">)</span>
            
            
            <span class="k">try</span><span class="p">:</span> <span class="k">assert</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_all_embeds</span><span class="p">[</span><span class="n">curr_cat</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">embedding_dim</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encountered an error for variable </span><span class="si">{</span><span class="n">curr_cat</span><span class="si">}</span><span class="s2">: Make sure embeddings dimensions are same for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">old_all_embeds</span><span class="p">[</span><span class="n">curr_cat</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Moving on to other cat vars&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
                
            
            <span class="n">old_curr_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_all_classes</span><span class="p">[</span><span class="n">curr_cat</span><span class="p">]</span>
            <span class="n">new_curr_classes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_all_classes</span><span class="p">[</span><span class="n">curr_cat</span><span class="p">]</span>
            <span class="k">global</span> <span class="n">temp</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">new_curr_classes</span>
            
            <span class="n">torch_embeds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_all_embeds</span><span class="p">[</span><span class="n">curr_cat</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">torch_embeds</span><span class="p">)</span>
            <span class="n">weights_mean</span> <span class="o">=</span> <span class="n">torch_embeds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mean is </span><span class="si">{</span><span class="n">weights_mean</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">torch_embeds</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">new_curr_class</span> <span class="ow">in</span> <span class="n">new_curr_classes</span><span class="p">:</span>
                <span class="n">new_curr_class_idx</span> <span class="o">=</span> <span class="n">new_curr_classes</span><span class="o">.</span><span class="n">o2i</span><span class="p">[</span><span class="n">new_curr_class</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_curr_class_idx</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">new_curr_class_idx</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">new_curr_class</span> <span class="ow">in</span> <span class="n">old_curr_classes</span><span class="p">:</span>
                    <span class="n">old_curr_class_idx</span> <span class="o">=</span> <span class="n">old_curr_classes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">new_curr_class</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transferring weights for class </span><span class="si">{</span><span class="n">new_curr_class</span><span class="si">}</span><span class="s1">, cat </span><span class="si">{</span><span class="n">curr_cat</span><span class="si">}</span><span class="s1"> from previous weights&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old weight for class is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">tempwgt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="n">tempwgt2</span> <span class="o">=</span> <span class="n">torch_embeds</span><span class="p">[</span><span class="n">old_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">torch_embeds</span><span class="p">[</span><span class="n">old_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">required_grad</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new weight for class is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Transferring weights for class </span><span class="si">{</span><span class="n">new_curr_class</span><span class="si">}</span><span class="s1">, cat </span><span class="si">{</span><span class="n">curr_cat</span><span class="si">}</span><span class="s1"> using mean&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;old weight for class is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">weights_mean</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">required_grad</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new weight for class is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">embeds</span><span class="p">[</span><span class="n">new_cat_idx</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span><span class="p">[</span><span class="n">new_curr_class_idx</span><span class="p">,</span> <span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        
    <span class="k">def</span> <span class="nf">save_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickle_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_learner</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pickle_name</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
<span class="c1">#             self.new_model = load_learner(data_dir +&#39;/&#39;+ &#39;{pickle_name}.pkl&#39;)</span>

    <span class="k">def</span> <span class="nf">load_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pickle_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">load_learner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pickle_name</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">)</span>
            
            
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tab_obj</span> <span class="o">=</span> <span class="n">TabTransfer</span><span class="p">(</span><span class="s1">&#39;../data/test.json&#39;</span><span class="p">,</span> <span class="n">learn2</span><span class="p">,</span> <span class="s1">&#39;/Users/rakshithacharya/Desktop/Jupyter-Notebooks&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tab_obj</span><span class="o">.</span><span class="n">read_json</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tab_obj</span><span class="o">.</span><span class="n">transfer</span><span class="p">([</span><span class="s2">&quot;sex&quot;</span><span class="p">],</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>tensor([[ 0.0078, -0.0057,  0.0079],
        [ 0.0084, -0.0047,  0.0006],
        [-0.0068, -0.0055,  0.0075]])
mean is tensor([ 0.0031, -0.0053,  0.0053]) for tensor([[ 0.0078, -0.0057,  0.0079],
        [ 0.0084, -0.0047,  0.0006],
        [-0.0068, -0.0055,  0.0075]])
0, &lt;class &#39;int&#39;&gt;
Transferring weights for class #na#, cat sex using mean
old weight for class is tensor([ 0.0031, -0.0053,  0.0053], grad_fn=&lt;SliceBackward&gt;)
new weight for class is tensor([ 0.0031, -0.0053,  0.0053], grad_fn=&lt;SliceBackward&gt;)
1, &lt;class &#39;int&#39;&gt;
Transferring weights for class Female, cat sex from previous weights
old weight for class is tensor([ 0.0078, -0.0057,  0.0079], grad_fn=&lt;SliceBackward&gt;)
new weight for class is tensor([ 0.0078, -0.0057,  0.0079], grad_fn=&lt;SliceBackward&gt;)
2, &lt;class &#39;int&#39;&gt;
Transferring weights for class Male, cat sex from previous weights
old weight for class is tensor([ 0.0084, -0.0047,  0.0006], grad_fn=&lt;SliceBackward&gt;)
new weight for class is tensor([ 0.0084, -0.0047,  0.0006], grad_fn=&lt;SliceBackward&gt;)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tab_obj</span><span class="o">.</span><span class="n">save_pickle</span><span class="p">(</span><span class="s1">&#39;test_pickle&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_model</span> <span class="o">=</span> <span class="n">tab_obj</span><span class="o">.</span><span class="n">load_pickle</span><span class="p">(</span><span class="s1">&#39;test_pickle&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">row_new_model</span><span class="p">,</span> <span class="n">clas_new_model</span><span class="p">,</span> <span class="n">probs_new_model</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">row_new_model</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>City</th>
      <th>sex</th>
      <th>Number</th>
      <th>Income</th>
      <th>Age</th>
      <th>Illness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Austin</td>
      <td>Female</td>
      <td>150000.001614</td>
      <td>87251.00002</td>
      <td>37.0</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clas_new_model</span><span class="p">,</span> <span class="n">probs_new_model</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(0), tensor([0.9316, 0.0684]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="===============================">===============================<a class="anchor-link" href="#==============================="> </a></h5>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>accuracy</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.289169</td>
      <td>0.282669</td>
      <td>0.919667</td>
      <td>00:16</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.283433</td>
      <td>0.279983</td>
      <td>0.919667</td>
      <td>00:16</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">row</span><span class="p">,</span> <span class="n">clas</span><span class="p">,</span> <span class="n">probs</span> <span class="o">=</span> <span class="n">learn2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">row</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>City</th>
      <th>sex</th>
      <th>Number</th>
      <th>Income</th>
      <th>Age</th>
      <th>Illness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Austin</td>
      <td>Female</td>
      <td>150000.001614</td>
      <td>87251.00002</td>
      <td>37.0</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">clas</span><span class="p">,</span> <span class="n">probs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(tensor(0), tensor([0.9018, 0.0982]))</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner_row</span><span class="p">,</span> <span class="n">learner_clas</span><span class="p">,</span> <span class="n">learner_probs</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">df2</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner_row</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>City</th>
      <th>sex</th>
      <th>Number</th>
      <th>Income</th>
      <th>Age</th>
      <th>Illness</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Austin</td>
      <td>Female</td>
      <td>150000.001614</td>
      <td>87251.00002</td>
      <td>37.0</td>
      <td>No</td>
    </tr>
  </tbody>
</table>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learner_probs</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>tensor([0.9316, 0.0684])</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

