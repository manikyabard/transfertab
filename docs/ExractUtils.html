---

title: Extraction Utilities


keywords: fastai
sidebar: home_sidebar

summary: "Contains helpful functions for extracting embeddings and preparing data for it."
description: "Contains helpful functions for extracting embeddings and preparing data for it."
nb_path: "nbs/00_ExractUtils.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_ExractUtils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll create a fastai learner, and extract embeddings from it. But it will be possible to do so for any pytorch model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">ADULT_SAMPLE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;adult.csv&#39;</span><span class="p">)</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">TabularDataLoaders</span><span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;adult.csv&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">y_names</span><span class="o">=</span><span class="s2">&quot;salary&quot;</span><span class="p">,</span>
    <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;workclass&#39;</span><span class="p">,</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="s1">&#39;marital-status&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">,</span> <span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;race&#39;</span><span class="p">,</span><span class="s1">&#39;sex&#39;</span><span class="p">],</span>
    <span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;fnlwgt&#39;</span><span class="p">,</span> <span class="s1">&#39;education-num&#39;</span><span class="p">],</span>
    <span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll need to create a metadata dictionary for the source data which contains all the categories, and the classes for each category in the given format.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;categories&quot;</span><span class="p">:[</span><span class="s1">&#39;workclass&#39;</span><span class="p">,</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="s1">&#39;marital-status&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">,</span> <span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;race&#39;</span><span class="p">],</span>
    <span class="s2">&quot;workclass&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; Private&#39;</span><span class="p">,</span> <span class="s1">&#39; Self-emp-inc&#39;</span><span class="p">,</span> <span class="s1">&#39; Self-emp-not-inc&#39;</span><span class="p">,</span> <span class="s1">&#39; State-gov&#39;</span><span class="p">,</span>
           <span class="s1">&#39; Federal-gov&#39;</span><span class="p">,</span> <span class="s1">&#39; Local-gov&#39;</span><span class="p">,</span> <span class="s1">&#39; ?&#39;</span><span class="p">,</span> <span class="s1">&#39; Without-pay&#39;</span><span class="p">,</span>
           <span class="s1">&#39; Never-worked&#39;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="s1">&#39;education&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; Assoc-acdm&#39;</span><span class="p">,</span> <span class="s1">&#39; Masters&#39;</span><span class="p">,</span> <span class="s1">&#39; HS-grad&#39;</span><span class="p">,</span> <span class="s1">&#39; Prof-school&#39;</span><span class="p">,</span> <span class="s1">&#39; 7th-8th&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Some-college&#39;</span><span class="p">,</span> <span class="s1">&#39; 11th&#39;</span><span class="p">,</span> <span class="s1">&#39; Bachelors&#39;</span><span class="p">,</span> <span class="s1">&#39; Assoc-voc&#39;</span><span class="p">,</span> <span class="s1">&#39; 10th&#39;</span><span class="p">,</span>
       <span class="s1">&#39; 9th&#39;</span><span class="p">,</span> <span class="s1">&#39; Doctorate&#39;</span><span class="p">,</span> <span class="s1">&#39; 12th&#39;</span><span class="p">,</span> <span class="s1">&#39; 1st-4th&#39;</span><span class="p">,</span> <span class="s1">&#39; 5th-6th&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Preschool&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;marital-status&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; Married-civ-spouse&#39;</span><span class="p">,</span> <span class="s1">&#39; Divorced&#39;</span><span class="p">,</span> <span class="s1">&#39; Never-married&#39;</span><span class="p">,</span> <span class="s1">&#39; Widowed&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Married-spouse-absent&#39;</span><span class="p">,</span> <span class="s1">&#39; Separated&#39;</span><span class="p">,</span> <span class="s1">&#39; Married-AF-spouse&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;occupation&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="s1">&#39; Exec-managerial&#39;</span><span class="p">,</span> <span class="s1">&#39; Prof-specialty&#39;</span><span class="p">,</span> <span class="s1">&#39; Other-service&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Handlers-cleaners&#39;</span><span class="p">,</span> <span class="s1">&#39; Craft-repair&#39;</span><span class="p">,</span> <span class="s1">&#39; Adm-clerical&#39;</span><span class="p">,</span> <span class="s1">&#39; Sales&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Machine-op-inspct&#39;</span><span class="p">,</span> <span class="s1">&#39; Transport-moving&#39;</span><span class="p">,</span> <span class="s1">&#39; ?&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Farming-fishing&#39;</span><span class="p">,</span> <span class="s1">&#39; Tech-support&#39;</span><span class="p">,</span> <span class="s1">&#39; Protective-serv&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Priv-house-serv&#39;</span><span class="p">,</span> <span class="s1">&#39; Armed-Forces&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;relationship&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; Wife&#39;</span><span class="p">,</span> <span class="s1">&#39; Not-in-family&#39;</span><span class="p">,</span> <span class="s1">&#39; Unmarried&#39;</span><span class="p">,</span> <span class="s1">&#39; Husband&#39;</span><span class="p">,</span> <span class="s1">&#39; Own-child&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Other-relative&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;race&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; White&#39;</span><span class="p">,</span> <span class="s1">&#39; Black&#39;</span><span class="p">,</span> <span class="s1">&#39; Asian-Pac-Islander&#39;</span><span class="p">,</span> <span class="s1">&#39; Amer-Indian-Eskimo&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Other&#39;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_meta_from_learner" class="doc_header"><code>extract_meta_from_learner</code><a href="https://github.com/manikyabard/transfertab/tree/master/transfertab/utils.py#L14" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_meta_from_learner</code>(<strong><code>learner</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extract_meta_from_df" class="doc_header"><code>extract_meta_from_df</code><a href="https://github.com/manikyabard/transfertab/tree/master/transfertab/utils.py#L26" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extract_meta_from_df</code>(<strong><code>df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CustomJSONizer" class="doc_header"><code>class</code> <code>CustomJSONizer</code><a href="https://github.com/manikyabard/transfertab/tree/master/transfertab/utils.py#L41" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CustomJSONizer</code>(<strong><code>skipkeys</code></strong>=<em><code>False</code></em>, <strong><code>ensure_ascii</code></strong>=<em><code>True</code></em>, <strong><code>check_circular</code></strong>=<em><code>True</code></em>, <strong><code>allow_nan</code></strong>=<em><code>True</code></em>, <strong><code>sort_keys</code></strong>=<em><code>False</code></em>, <strong><code>indent</code></strong>=<em><code>None</code></em>, <strong><code>separators</code></strong>=<em><code>None</code></em>, <strong><code>default</code></strong>=<em><code>None</code></em>) :: <code>JSONEncoder</code></p>
</blockquote>

<pre><code>Extensible JSON &lt;http://json.org&gt; encoder for Python data structures.

Supports the following objects and types by default:

+-------------------+---------------+
| Python            | JSON          |
+===================+===============+
| dict              | object        |
+-------------------+---------------+
| list, tuple       | array         |
+-------------------+---------------+
| str               | string        |
+-------------------+---------------+
| int, float        | number        |
+-------------------+---------------+
| True              | true          |
+-------------------+---------------+
| False             | false         |
+-------------------+---------------+
| None              | null          |
+-------------------+---------------+

To extend this to recognize other objects, subclass and implement a
``.default()`` method with another method that returns a serializable
object for ``o`` if possible, otherwise it should call the superclass
implementation (to raise ``TypeError``).</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="extractembeds" class="doc_header"><code>extractembeds</code><a href="https://github.com/manikyabard/transfertab/tree/master/transfertab/utils.py#L48" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>extractembeds</code>(<strong><code>model</code></strong>, <strong><code>embeddinglg</code></strong>:<code>str</code>, <strong><code>metadict</code></strong>, <strong><code>path</code></strong>)</p>
</blockquote>

<pre><code>model: Any pytorch model, containing a layergroup with all the embedding layers.
embeddinglg: Name of the layer group containing the embedding layers.
metadict: A dictionary containing relevant metadata. Check the format given in docs for further details.
path: Path of the json</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">meta_new</span><span class="o">=</span><span class="n">extract_meta_from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
<span class="n">embeddict</span> <span class="o">=</span> <span class="n">extractembeds</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;embeds&quot;</span><span class="p">,</span> <span class="n">meta_new</span><span class="p">,</span> <span class="s2">&quot;test.json&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">embeddict</span><span class="p">[</span><span class="s1">&#39;education-num_na&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;classes&#39;: [&#39;#na#&#39;, False, True],
 &#39;embeddings&#39;: [[3.5684544855030254e-05,
   0.002612957963719964,
   0.013382526114583015],
  [-0.0011584986932575703, 0.006993609014898539, 0.0005290795234031975],
  [-0.019433515146374702, -0.004828458186239004, -0.002685201819986105]]}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>  
       
<span class="c1"># Data to be written  </span>
<span class="n">dictionary</span> <span class="o">=</span><span class="p">{</span>  
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;04&quot;</span><span class="p">,</span>  
  <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;sunil&quot;</span><span class="p">,</span>  
  <span class="s2">&quot;depatment&quot;</span><span class="p">:</span> <span class="s2">&quot;HR&quot;</span>
<span class="p">}</span>  
<span class="nb">print</span><span class="p">(</span><span class="n">dictionary</span><span class="p">)</span>
<span class="c1"># Serializing json   </span>
<span class="n">json_object</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>  
<span class="nb">print</span><span class="p">(</span><span class="n">json_object</span><span class="p">)</span> 
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>{&#39;id&#39;: &#39;04&#39;, &#39;name&#39;: &#39;sunil&#39;, &#39;depatment&#39;: &#39;HR&#39;}
{
    &#34;id&#34;: &#34;04&#34;,
    &#34;name&#34;: &#34;sunil&#34;,
    &#34;depatment&#34;: &#34;HR&#34;
}
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

