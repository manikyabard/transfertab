---

title: Extraction Utilities (Archived)


keywords: fastai
sidebar: home_sidebar

summary: "Contains helpful functions for extracting embeddings and preparing data for it."
description: "Contains helpful functions for extracting embeddings and preparing data for it."
nb_path: "nbs/00_oldExractUtils.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/00_oldExractUtils.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.tabular.all</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll create a fastai learner, and extract embeddings from it. But it will be possible to do so for any pytorch model.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">ADULT_SAMPLE</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;adult.csv&#39;</span><span class="p">)</span>
<span class="n">dls</span> <span class="o">=</span> <span class="n">TabularDataLoaders</span><span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;adult.csv&#39;</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">y_names</span><span class="o">=</span><span class="s2">&quot;salary&quot;</span><span class="p">,</span>
    <span class="n">cat_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;workclass&#39;</span><span class="p">,</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="s1">&#39;marital-status&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">,</span> <span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;race&#39;</span><span class="p">,</span><span class="s1">&#39;sex&#39;</span><span class="p">],</span>
    <span class="n">cont_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;fnlwgt&#39;</span><span class="p">,</span> <span class="s1">&#39;education-num&#39;</span><span class="p">],</span>
    <span class="n">procs</span> <span class="o">=</span> <span class="p">[</span><span class="n">Categorify</span><span class="p">,</span> <span class="n">FillMissing</span><span class="p">,</span> <span class="n">Normalize</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">tabular_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">accuracy</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We'll need to create a metadata dictionary for the source data which contains all the categories, and the classes for each category in the given format.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">meta</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;categories&quot;</span><span class="p">:[</span><span class="s1">&#39;workclass&#39;</span><span class="p">,</span> <span class="s1">&#39;education&#39;</span><span class="p">,</span> <span class="s1">&#39;marital-status&#39;</span><span class="p">,</span> <span class="s1">&#39;occupation&#39;</span><span class="p">,</span> <span class="s1">&#39;relationship&#39;</span><span class="p">,</span> <span class="s1">&#39;race&#39;</span><span class="p">],</span>
    <span class="s2">&quot;workclass&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; Private&#39;</span><span class="p">,</span> <span class="s1">&#39; Self-emp-inc&#39;</span><span class="p">,</span> <span class="s1">&#39; Self-emp-not-inc&#39;</span><span class="p">,</span> <span class="s1">&#39; State-gov&#39;</span><span class="p">,</span>
           <span class="s1">&#39; Federal-gov&#39;</span><span class="p">,</span> <span class="s1">&#39; Local-gov&#39;</span><span class="p">,</span> <span class="s1">&#39; ?&#39;</span><span class="p">,</span> <span class="s1">&#39; Without-pay&#39;</span><span class="p">,</span>
           <span class="s1">&#39; Never-worked&#39;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="s1">&#39;education&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; Assoc-acdm&#39;</span><span class="p">,</span> <span class="s1">&#39; Masters&#39;</span><span class="p">,</span> <span class="s1">&#39; HS-grad&#39;</span><span class="p">,</span> <span class="s1">&#39; Prof-school&#39;</span><span class="p">,</span> <span class="s1">&#39; 7th-8th&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Some-college&#39;</span><span class="p">,</span> <span class="s1">&#39; 11th&#39;</span><span class="p">,</span> <span class="s1">&#39; Bachelors&#39;</span><span class="p">,</span> <span class="s1">&#39; Assoc-voc&#39;</span><span class="p">,</span> <span class="s1">&#39; 10th&#39;</span><span class="p">,</span>
       <span class="s1">&#39; 9th&#39;</span><span class="p">,</span> <span class="s1">&#39; Doctorate&#39;</span><span class="p">,</span> <span class="s1">&#39; 12th&#39;</span><span class="p">,</span> <span class="s1">&#39; 1st-4th&#39;</span><span class="p">,</span> <span class="s1">&#39; 5th-6th&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Preschool&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;marital-status&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; Married-civ-spouse&#39;</span><span class="p">,</span> <span class="s1">&#39; Divorced&#39;</span><span class="p">,</span> <span class="s1">&#39; Never-married&#39;</span><span class="p">,</span> <span class="s1">&#39; Widowed&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Married-spouse-absent&#39;</span><span class="p">,</span> <span class="s1">&#39; Separated&#39;</span><span class="p">,</span> <span class="s1">&#39; Married-AF-spouse&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;occupation&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;nan&quot;</span><span class="p">,</span> <span class="s1">&#39; Exec-managerial&#39;</span><span class="p">,</span> <span class="s1">&#39; Prof-specialty&#39;</span><span class="p">,</span> <span class="s1">&#39; Other-service&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Handlers-cleaners&#39;</span><span class="p">,</span> <span class="s1">&#39; Craft-repair&#39;</span><span class="p">,</span> <span class="s1">&#39; Adm-clerical&#39;</span><span class="p">,</span> <span class="s1">&#39; Sales&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Machine-op-inspct&#39;</span><span class="p">,</span> <span class="s1">&#39; Transport-moving&#39;</span><span class="p">,</span> <span class="s1">&#39; ?&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Farming-fishing&#39;</span><span class="p">,</span> <span class="s1">&#39; Tech-support&#39;</span><span class="p">,</span> <span class="s1">&#39; Protective-serv&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Priv-house-serv&#39;</span><span class="p">,</span> <span class="s1">&#39; Armed-Forces&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;relationship&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; Wife&#39;</span><span class="p">,</span> <span class="s1">&#39; Not-in-family&#39;</span><span class="p">,</span> <span class="s1">&#39; Unmarried&#39;</span><span class="p">,</span> <span class="s1">&#39; Husband&#39;</span><span class="p">,</span> <span class="s1">&#39; Own-child&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Other-relative&#39;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;race&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;nan&#39;</span><span class="p">,</span> <span class="s1">&#39; White&#39;</span><span class="p">,</span> <span class="s1">&#39; Black&#39;</span><span class="p">,</span> <span class="s1">&#39; Asian-Pac-Islander&#39;</span><span class="p">,</span> <span class="s1">&#39; Amer-Indian-Eskimo&#39;</span><span class="p">,</span>
       <span class="s1">&#39; Other&#39;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Meta Format: {&#39;categories&#39;:[&#39;cat1&#39;,&#39;cat2&#39;......],&#39;cat1&#39;:{&#39;classes&#39;:[&#39;class1&#39;,&#39;class2&#39;......]},&#39;cat2&#39;:...........}</span>
<span class="k">def</span> <span class="nf">extract_meta_from_learner</span><span class="p">(</span><span class="n">learner</span><span class="p">):</span>
    <span class="n">cat_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">categorify</span><span class="o">.</span><span class="n">classes</span><span class="p">:</span>
        <span class="n">cat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">temp_meta</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">cat_list</span><span class="p">)</span>
    <span class="n">t</span><span class="o">=</span><span class="n">learner</span><span class="o">.</span><span class="n">dls</span><span class="o">.</span><span class="n">categorify</span><span class="o">.</span><span class="n">classes</span>
    <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;categories&quot;</span><span class="p">:</span><span class="n">cat_list</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">temp_meta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;classes&quot;</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])}</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">temp_meta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">meta</span>

<span class="k">def</span> <span class="nf">extract_meta_from_df</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">cat_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
            <span class="n">cat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">cat_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">cat_list</span><span class="p">)</span>
    <span class="n">meta</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;categories&#39;</span><span class="p">:</span><span class="n">cat_list</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cat_dict</span><span class="p">:</span>
        <span class="n">cat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cat_dict</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;classes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">meta</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cat_dict</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">meta</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">CustomJSONizer</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONEncoder</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span> \
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span> \
            <span class="k">else</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">extractembeds</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">embeddinglg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadict</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    model: Any pytorch model, containing a layergroup with all the embedding layers.</span>
<span class="sd">    embeddinglg: Name of the layer group containing the embedding layers.</span>
<span class="sd">    metadict: A dictionary containing relevant metadata. Check the format given in docs for further details.</span>
<span class="sd">    path: Path of the json </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">embedsdict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">metadict</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">metadict</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">classes</span> <span class="o">=</span> <span class="n">metadict</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span>
            <span class="n">layer</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">embeddinglg</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">assert</span> <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">num_embeddings</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)),</span> <span class="sa">f</span><span class="s2">&quot;embeddings dimension </span><span class="si">{</span><span class="n">layer</span><span class="o">.</span><span class="n">num_embeddings</span><span class="si">}</span><span class="s2"> !=  num of classes </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span><span class="si">}</span><span class="s2"> for vairable </span><span class="si">{</span><span class="n">cat</span><span class="si">}</span><span class="s2">. Embeddings should have same number of classes. Something might have gone wrong.&quot;</span>
            <span class="n">embedsdict</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;embeddings&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">embedsdict</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span><span class="bp">cls</span><span class="o">=</span><span class="n">CustomJSONizer</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">embedsdict</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">meta_new</span><span class="o">=</span><span class="n">extract_meta_from_learner</span><span class="p">(</span><span class="n">learn</span><span class="p">)</span>
<span class="n">embeddict</span> <span class="o">=</span> <span class="n">extractembeds</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;embeds&quot;</span><span class="p">,</span> <span class="n">meta_new</span><span class="p">,</span> <span class="s2">&quot;test.json&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">embeddict</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[&#39;workclass&#39;,
 &#39;education&#39;,
 &#39;marital-status&#39;,
 &#39;occupation&#39;,
 &#39;relationship&#39;,
 &#39;race&#39;,
 &#39;sex&#39;,
 &#39;education-num_na&#39;]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

